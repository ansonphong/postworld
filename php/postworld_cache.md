# Caching
------

## New Caching Structure 
#### (In development)

Table name : __wp_postworld_cache__

## Columns:
- __cache_id__
    + Numerical ID, auto incremented
- __cache_type__ : *optional*
    + String indicating the type of cache
    + Generally used for resetting caches
    + _Options_: `query` / `feed`, `term-feed`, `iconset`
- __cache_name__ : *optional*
    + String indicating the name of the cache
    + This is used for identifying the cache by name
- __cache_hash__ : *required*
    + A sting representing the hash
    + This can be generated by, for instance, a query string, to identify the validity of the cache
- __cache_content__ : *required*
    + The actual content in the cache, such as a JSON string

-----------
## Methods
-----------

### pw_set_cache( *$data* )
- Inserts data into the cache table
- Deletes other cache entries with the same `cache_name` or `cache_hash`

```php
$data = array(
    'cache_type'    =>  [string],
    'cache_name'    =>  [string],
    'cache_hash'    =>  [string],
    'cache_content' =>  [string]  
)
```


### pw_delete_cache( *$data* )
- Deletes data from the cache table
- Contains an associative array of where clauses

```php
$data = array(
    'cache_type'    =>  [string],
    'cache_name'    =>  [string],
    'cache_hash'    =>  [string],
    'cache_content' =>  [string]  
)
```


### pw_get_cache( *$vars*, *$operator* )
- Gets first matching row from the cache table

```php
$vars = array(
    'cache_hash'    =>  [string],
    'cache_name'    =>  [string],
)
```

#### Parameters
__$vars__ : *array*
- Supported keys:
    + __cache_hash__
    + __cache_name__

__$operator__ : *string*
- Options:
    + __AND__ *(default)*
    + __OR__

### pw_set_feed_cache( *$vars* )
- Preprocesses and saves the feed in the cache


### pw_get_feed_cache( *$query* )
- Generates hash of JSON query string, and queries cache table
- If no cache exists, 


### pw_reset_cache()
- Clears the entire cache table

### pw_reset_cache_type( *$type* )
- Resets a particular cache type



------

### cache_all_points ()
- Runs cache_user_points() and cache_post_points()

__return__ : *cron_logs Object* (add to table wp_postworld_cron_logs)

------

### cache_all_user_points()
- Cycles through all users with cache_user_points() method

__return__ : *cron_logs* Object (add to table wp_postworld_cron_logs)

------

### cache_all_post_points()
- Cycles through each post in each post_type with points enabled
- Calculates and caches each post's current points with cache_post_points() method

__return__ : *cron_logs* Object (add to table wp_postworld_cron_logs)

------

### cache_all_comment_points()
- Cycles through all columns
- Calculates and caches each comment's current points with cache_comment_points() method

__return__ : *cron_logs* Object (add to table wp_postworld_cron_logs)

------

### cache_all_rank_scores ()
- Cycles through each post in each post_type scheduled for Rank Score caching
- Calculates and caches each post's current rank with cache_rank_score() method
__return__ : *cron_logs* Object (add to table wp_postworld_cron_logs)

#### Solutions to Known Issues with PHP Timelimit

- Adapting the wp-config.php:

``` php
set_time_limit(600);
define( 'WP_MAX_MEMORY_LIMIT', '512M' );
define( 'WP_MEMORY_LIMIT', '512M' );
```

- Adapting the /.htaccess file of your WordPress installation
    - (only works if PHP is running as a PHP module)

```
php_value max_execution_time 600
php_value memory_limit 512M
```

- Adapting the php.ini file

```
max_execution_time = 600;
memory_limit = 512M;
```

------

### cache_all_feeds ()
- Run pw_cache_feed() method for each feed registered for feed caching in WP Options
__return__ : *cron_logs* Object (store in table wp_postworld_cron_logs)

------

SHARES

------

### cache_shares ( *[$cache_all]* )

#### Description
- Caches user and post share reports from the __Shares__ table

#### Paramaters
__$cache_all__ : *boolean*  
Default : *false*

#### Process
- If `$cache_all = false`, just update the recently changed share reports
    - Check __Cron Logs__ table for the most recent start time of the last `cache_shares()` operation

    - __POSTS :__  
    Get an array of all __post_IDs__ from __Shares__ table which have been updated since the most recent run of `cache_shares()` by checking the __last time__ column  
    Run `cache_post_shares($post_id)` for all recently updated shares

    - __AUTHORS :__  
    Get an array of all __post_author_IDs__ from __Shares__ table  which have been updated since the last cache.  
    Run `cache_user_shares($user_id,'incoming')` for all recently updated user's shares

     - __USERS :__  
    Get an array of all __user_IDs__ from __Shares__ table  which have been updated since the last cache.
    Run `cache_user_shares($user_id,'outgoing')` for all recently updated user's shares

- If `$cache_all = true`
    - Cycle through every post and run `cache_post_shares($post_id)`
    - Cycle through every author and run `cache_user_shares($user_id,'incoming')`
    - Cycle through every user and run `cache_user_shares($user_id,'outgoing')`

__return__ : *cron_logs* Object (store in table wp_postworld_cron_logs)

------

POST SHARES

------

### calculate_post_shares( *$post_id* )
- Calculates the total number of shares to the given post

#### Process
- Lookup the given __post_id__ in the __Shares__ table
- Add up ( *SUM* ) the total number in __shares__ column attributed to the post

__return__ : *integer* (number of shares)

------

### cache_post_shares( *$post_id* )
- Caches the total number of shares to the given post

#### Process
- Run `calculate_post_shares($post_id)`
- Write the result to the __post_shares__ column in the __Post Meta__ table

__return__ : *integer* (number of shares)

------

USER SHARES

------

### calculate_user_shares( *$user_id, [$mode]* )
- Calculates the total number of shares relating to a given user

#### Parameters
__$user_id__ : *integer*

__$mode__ : *string* (optional)
- Options :
    - __both__ (default) : Return both __incoming__ and __outgoing__ 
    - __incoming__ : Return shares attributed to the user's posts  
    - __outgoing__ : Return shares that the user has initiated

#### Process
- Lookup the given __user_id__ in the __Shares__ table
- Modes :
    - For __incoming__ : Match to __author_id__ column in __Shares__ table 
    - For __outgoing__ : Match to __user_id__ column in __Shares__ table
- Add up *(SUM)* the total number of the __shares__ column attributed to the user, according to `$mode`

__return__ : *Array* (number of shares)

```php
array(
    'incoming' => {{integer}},
    'outgoing' => {{integer}}
    )
```

------

### cache_user_shares( *$user_id, [$mode]* )
- Caches the total number of shares relating to a given user

#### Process
- Run `calculate_user_shares()`
- Update the __user_shares__ column in the __User Meta__ table

__return__ : *integer* (number of shares)

------

CRON LOGS

------

### clear_cron_logs ( *$timestamp* )
- Count number of rows in wp_postworld_cron_logs (rows_before)
- Deletes all rows which are before the specified timestamp (rows_removed)
- Count number of rows after clearing (rows_after)

__return__ : *Object*
``` php
    'rows_before' => {{integer}}
    'rows_removed' => {{integer}}
    'rows_after' => {{integer}}
```

------

### Objects Anatomy : 

#### cron_logs *Object*
``` php
    'type' => {{feed/post_type}}
    'query_id' => {{feed id / post_type slug}}
    'time_start' => {{timestamp}}
    'time_end' => {{timestamp}}
    'timer' => {{milliseconds}}
    'posts' => {{number of posts}}
    'timer_average' => {{milliseconds}}
    'query_vars' => {{ query_vars Object }}
```

#### query_vars *Object*
``` php
    'post_type' => {{string}}
    'class' => {{string}}
    'format' => {{string}}
    etc...
```
